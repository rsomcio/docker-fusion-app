/** Copyright (c) 2018 Uber Technologies, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * 
 */

/* eslint-env node */
import path from 'path';
import fs from 'fs';
import React from 'react';
import { createPlugin, dangerouslySetHTML } from 'fusion-core';
import { Provider as StyletronProvider } from 'styletron-react';
import { Server as Styletron } from 'styletron-engine-atomic';
import { injectDeclarationCompatMixin } from './inject-declaration-compat-mixin.js';
import { workerRoute, wasmRoute, AtomicPrefixToken } from './constants.js';
let workerPath;
let wasmPath;

if (process.env.NODE_ENV !== "production" && true) {
  const base = path.dirname(require.resolve('css-to-js-sourcemap-worker'));
  workerPath = path.resolve(base, 'worker.js');
  wasmPath = path.resolve(base, 'mappings.wasm');
}

const StyletronCompat = injectDeclarationCompatMixin(Styletron);
const plugin = true && createPlugin({
  deps: {
    prefix: AtomicPrefixToken.optional
  },
  middleware: ({
    prefix
  }) => (ctx, next) => {
    if (process.env.NODE_ENV !== "production") {
      if (ctx.url === workerRoute) {
        ctx.body = fs.createReadStream(workerPath);
        return next();
      }

      if (ctx.url === wasmRoute) {
        ctx.body = fs.createReadStream(wasmPath);
        return next();
      }
    }

    if (ctx.element) {
      const config = prefix === void 0 ? void 0 : {
        prefix
      };
      const engine = new StyletronCompat(config);
      ctx.element = React.createElement(StyletronProvider, {
        value: engine
      }, ctx.element);
      return next().then(() => {
        const stylesForHead = engine.getStylesheetsHtml();
        ctx.template.head.push(dangerouslySetHTML(stylesForHead));
      });
    } else {
      return next();
    }
  }
});
export default plugin;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZlci5qcyJdLCJuYW1lcyI6WyJwYXRoIiwiZnMiLCJSZWFjdCIsImNyZWF0ZVBsdWdpbiIsImRhbmdlcm91c2x5U2V0SFRNTCIsIlByb3ZpZGVyIiwiU3R5bGV0cm9uUHJvdmlkZXIiLCJTZXJ2ZXIiLCJTdHlsZXRyb24iLCJpbmplY3REZWNsYXJhdGlvbkNvbXBhdE1peGluIiwid29ya2VyUm91dGUiLCJ3YXNtUm91dGUiLCJBdG9taWNQcmVmaXhUb2tlbiIsIndvcmtlclBhdGgiLCJ3YXNtUGF0aCIsImJhc2UiLCJkaXJuYW1lIiwicmVxdWlyZSIsInJlc29sdmUiLCJTdHlsZXRyb25Db21wYXQiLCJwbHVnaW4iLCJkZXBzIiwicHJlZml4Iiwib3B0aW9uYWwiLCJtaWRkbGV3YXJlIiwiY3R4IiwibmV4dCIsInVybCIsImJvZHkiLCJjcmVhdGVSZWFkU3RyZWFtIiwiZWxlbWVudCIsImNvbmZpZyIsImVuZ2luZSIsInRoZW4iLCJzdHlsZXNGb3JIZWFkIiwiZ2V0U3R5bGVzaGVldHNIdG1sIiwidGVtcGxhdGUiLCJoZWFkIiwicHVzaCJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7O0FBUUE7QUFFQSxPQUFPQSxJQUFQLE1BQWlCLE1BQWpCO0FBQ0EsT0FBT0MsRUFBUCxNQUFlLElBQWY7QUFFQSxPQUFPQyxLQUFQLE1BQWtCLE9BQWxCO0FBQ0EsU0FBUUMsWUFBUixFQUFzQkMsa0JBQXRCLFFBQStDLGFBQS9DO0FBR0EsU0FBUUMsUUFBUSxJQUFJQyxpQkFBcEIsUUFBNEMsaUJBQTVDO0FBQ0EsU0FBUUMsTUFBTSxJQUFJQyxTQUFsQixRQUFrQyx5QkFBbEM7QUFFQSxTQUFRQyw0QkFBUixRQUEyQyxzQ0FBM0M7QUFDQSxTQUFRQyxXQUFSLEVBQXFCQyxTQUFyQixFQUFnQ0MsaUJBQWhDLFFBQXdELGdCQUF4RDtBQUVBLElBQUlDLFVBQUo7QUFDQSxJQUFJQyxRQUFKOztBQUVBLElBQUksNkNBQUosRUFBeUI7QUFDdkIsUUFBTUMsSUFBSSxHQUFHZixJQUFJLENBQUNnQixPQUFMLENBQWFDLE9BQU8sQ0FBQ0MsT0FBUixDQUFnQiw0QkFBaEIsQ0FBYixDQUFiO0FBQ0FMLEVBQUFBLFVBQVUsR0FBR2IsSUFBSSxDQUFDa0IsT0FBTCxDQUFhSCxJQUFiLEVBQW1CLFdBQW5CLENBQWI7QUFDQUQsRUFBQUEsUUFBUSxHQUFHZCxJQUFJLENBQUNrQixPQUFMLENBQWFILElBQWIsRUFBbUIsZUFBbkIsQ0FBWDtBQUNEOztBQUVELE1BQU1JLGVBQWUsR0FBR1YsNEJBQTRCLENBQUNELFNBQUQsQ0FBcEQ7QUFFQSxNQUFNWSxNQUFNLEdBQ1YsUUFDQWpCLFlBQVksQ0FBQztBQUNYa0IsRUFBQUEsSUFBSSxFQUFFO0FBQ0pDLElBQUFBLE1BQU0sRUFBRVYsaUJBQWlCLENBQUNXO0FBRHRCLEdBREs7QUFJWEMsRUFBQUEsVUFBVSxFQUFFLENBQUM7QUFBQ0YsSUFBQUE7QUFBRCxHQUFELEtBQWMsQ0FBQ0csR0FBRCxFQUFNQyxJQUFOLEtBQWU7QUFDdkMsK0NBQWE7QUFDWCxVQUFJRCxHQUFHLENBQUNFLEdBQUosS0FBWWpCLFdBQWhCLEVBQTZCO0FBQzNCZSxRQUFBQSxHQUFHLENBQUNHLElBQUosR0FBVzNCLEVBQUUsQ0FBQzRCLGdCQUFILENBQW9CaEIsVUFBcEIsQ0FBWDtBQUNBLGVBQU9hLElBQUksRUFBWDtBQUNEOztBQUNELFVBQUlELEdBQUcsQ0FBQ0UsR0FBSixLQUFZaEIsU0FBaEIsRUFBMkI7QUFDekJjLFFBQUFBLEdBQUcsQ0FBQ0csSUFBSixHQUFXM0IsRUFBRSxDQUFDNEIsZ0JBQUgsQ0FBb0JmLFFBQXBCLENBQVg7QUFDQSxlQUFPWSxJQUFJLEVBQVg7QUFDRDtBQUNGOztBQUVELFFBQUlELEdBQUcsQ0FBQ0ssT0FBUixFQUFpQjtBQUNmLFlBQU1DLE1BQU0sR0FBR1QsTUFBTSxLQUFLLEtBQUssQ0FBaEIsR0FBb0IsS0FBSyxDQUF6QixHQUE2QjtBQUFDQSxRQUFBQTtBQUFELE9BQTVDO0FBQ0EsWUFBTVUsTUFBTSxHQUFHLElBQUliLGVBQUosQ0FBb0JZLE1BQXBCLENBQWY7QUFFQU4sTUFBQUEsR0FBRyxDQUFDSyxPQUFKLEdBQ0Usb0JBQUMsaUJBQUQ7QUFBbUIsUUFBQSxLQUFLLEVBQUVFO0FBQTFCLFNBQW1DUCxHQUFHLENBQUNLLE9BQXZDLENBREY7QUFJQSxhQUFPSixJQUFJLEdBQUdPLElBQVAsQ0FBWSxNQUFNO0FBQ3ZCLGNBQU1DLGFBQWEsR0FBR0YsTUFBTSxDQUFDRyxrQkFBUCxFQUF0QjtBQUNBVixRQUFBQSxHQUFHLENBQUNXLFFBQUosQ0FBYUMsSUFBYixDQUFrQkMsSUFBbEIsQ0FBdUJsQyxrQkFBa0IsQ0FBQzhCLGFBQUQsQ0FBekM7QUFDRCxPQUhNLENBQVA7QUFJRCxLQVpELE1BWU87QUFDTCxhQUFPUixJQUFJLEVBQVg7QUFDRDtBQUNGO0FBL0JVLENBQUQsQ0FGZDtBQW9DQSxlQUFpQk4sTUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyIvKiogQ29weXJpZ2h0IChjKSAyMDE4IFViZXIgVGVjaG5vbG9naWVzLCBJbmMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICogQGZsb3dcbiAqL1xuXG4vKiBlc2xpbnQtZW52IG5vZGUgKi9cblxuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHtjcmVhdGVQbHVnaW4sIGRhbmdlcm91c2x5U2V0SFRNTH0gZnJvbSAnZnVzaW9uLWNvcmUnO1xuaW1wb3J0IHR5cGUge0Z1c2lvblBsdWdpbn0gZnJvbSAnZnVzaW9uLWNvcmUnO1xuXG5pbXBvcnQge1Byb3ZpZGVyIGFzIFN0eWxldHJvblByb3ZpZGVyfSBmcm9tICdzdHlsZXRyb24tcmVhY3QnO1xuaW1wb3J0IHtTZXJ2ZXIgYXMgU3R5bGV0cm9ufSBmcm9tICdzdHlsZXRyb24tZW5naW5lLWF0b21pYyc7XG5cbmltcG9ydCB7aW5qZWN0RGVjbGFyYXRpb25Db21wYXRNaXhpbn0gZnJvbSAnLi9pbmplY3QtZGVjbGFyYXRpb24tY29tcGF0LW1peGluLmpzJztcbmltcG9ydCB7d29ya2VyUm91dGUsIHdhc21Sb3V0ZSwgQXRvbWljUHJlZml4VG9rZW59IGZyb20gJy4vY29uc3RhbnRzLmpzJztcblxubGV0IHdvcmtlclBhdGg7XG5sZXQgd2FzbVBhdGg7XG5cbmlmIChfX0RFVl9fICYmIF9fTk9ERV9fKSB7XG4gIGNvbnN0IGJhc2UgPSBwYXRoLmRpcm5hbWUocmVxdWlyZS5yZXNvbHZlKCdjc3MtdG8tanMtc291cmNlbWFwLXdvcmtlcicpKTtcbiAgd29ya2VyUGF0aCA9IHBhdGgucmVzb2x2ZShiYXNlLCAnd29ya2VyLmpzJyk7XG4gIHdhc21QYXRoID0gcGF0aC5yZXNvbHZlKGJhc2UsICdtYXBwaW5ncy53YXNtJyk7XG59XG5cbmNvbnN0IFN0eWxldHJvbkNvbXBhdCA9IGluamVjdERlY2xhcmF0aW9uQ29tcGF0TWl4aW4oU3R5bGV0cm9uKTtcblxuY29uc3QgcGx1Z2luID1cbiAgX19OT0RFX18gJiZcbiAgY3JlYXRlUGx1Z2luKHtcbiAgICBkZXBzOiB7XG4gICAgICBwcmVmaXg6IEF0b21pY1ByZWZpeFRva2VuLm9wdGlvbmFsLFxuICAgIH0sXG4gICAgbWlkZGxld2FyZTogKHtwcmVmaXh9KSA9PiAoY3R4LCBuZXh0KSA9PiB7XG4gICAgICBpZiAoX19ERVZfXykge1xuICAgICAgICBpZiAoY3R4LnVybCA9PT0gd29ya2VyUm91dGUpIHtcbiAgICAgICAgICBjdHguYm9keSA9IGZzLmNyZWF0ZVJlYWRTdHJlYW0od29ya2VyUGF0aCk7XG4gICAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoY3R4LnVybCA9PT0gd2FzbVJvdXRlKSB7XG4gICAgICAgICAgY3R4LmJvZHkgPSBmcy5jcmVhdGVSZWFkU3RyZWFtKHdhc21QYXRoKTtcbiAgICAgICAgICByZXR1cm4gbmV4dCgpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmIChjdHguZWxlbWVudCkge1xuICAgICAgICBjb25zdCBjb25maWcgPSBwcmVmaXggPT09IHZvaWQgMCA/IHZvaWQgMCA6IHtwcmVmaXh9O1xuICAgICAgICBjb25zdCBlbmdpbmUgPSBuZXcgU3R5bGV0cm9uQ29tcGF0KGNvbmZpZyk7XG5cbiAgICAgICAgY3R4LmVsZW1lbnQgPSAoXG4gICAgICAgICAgPFN0eWxldHJvblByb3ZpZGVyIHZhbHVlPXtlbmdpbmV9PntjdHguZWxlbWVudH08L1N0eWxldHJvblByb3ZpZGVyPlxuICAgICAgICApO1xuXG4gICAgICAgIHJldHVybiBuZXh0KCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgY29uc3Qgc3R5bGVzRm9ySGVhZCA9IGVuZ2luZS5nZXRTdHlsZXNoZWV0c0h0bWwoKTtcbiAgICAgICAgICBjdHgudGVtcGxhdGUuaGVhZC5wdXNoKGRhbmdlcm91c2x5U2V0SFRNTChzdHlsZXNGb3JIZWFkKSk7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgIH1cbiAgICB9LFxuICB9KTtcblxuZXhwb3J0IGRlZmF1bHQgKChwbHVnaW46IGFueSk6IEZ1c2lvblBsdWdpbjwqLCAqPik7XG4iXX0=